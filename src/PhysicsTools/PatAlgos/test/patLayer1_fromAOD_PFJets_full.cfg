process PAT = {


  ### General ###

  # initialize MessageLogger
  include "FWCore/MessageLogger/data/MessageLogger.cfi"
  replace MessageLogger.cerr.threshold = "INFO"
  replace MessageLogger.categories += "PATLayer0Summary"
  replace MessageLogger.cerr.INFO = {
      untracked PSet default = { untracked int32 limit = 0  }
      untracked PSet PATLayer0Summary = { untracked int32 limit = -1 }
  }

  # return filter & timing reports
  untracked PSet options = { untracked bool wantSummary = true }


  ### Input ###

  untracked PSet maxEvents = { untracked int32 input = 100 }

  source = PoolSource { untracked vstring fileNames = { 'file:/afs/cern.ch/cms/PRS/top/cmssw-data/relval200-for-pat-testing/RelValTTbar-200p7-AODSIM.100.root' } }

  ### PAT steering ###

  include "PhysicsTools/PatAlgos/data/patLayer0.cff"
  #include "PhysicsTools/PatAlgos/test/patLayer0_ReplaceDefaults_full.cff" # NOTE: it won't work with this uncommented
                                                                           # read below for more details
  include "PhysicsTools/PatAlgos/data/patLayer1.cff"
  #include "PhysicsTools/PatAlgos/test/patLayer1_ReplaceDefaults_full.cff"
 
  module content = EventContentAnalyzer { }

  ## NOTE: if you use ReplaceDefaults you will have to change remove this list of replace statements
  ##       and change the 'replace' in the ReplaceDefaults file.
  ## Pick up the module that defines PFJets
  include "RecoParticleFlow/PFProducer/data/particleFlow.cff"
  ## MC Matching
  replace jetPartonMatch.src = allLayer0PFJets
  replace jetGenJetMatch.src = allLayer0PFJets
  //## Flavour Matching
  replace jetPartonAssociation.jets = allLayer0PFJets
  ## Track matching (non trivial)
  ### part 1: run JetTracksAssociation, as it's not in AOD for PFJets.
  include "RecoJets/JetAssociationProducers/data/j2tParametersVX.cfi"
  module ic5PFJetTracksAssociatorAtVertex = JetTracksAssociatorAtVertex {
     using j2tParametersVX
     InputTag jets = iterativeCone5PFJets
  }
  ### part 2: convert to PAT
  replace patAODJetTracksAssociator.src    = iterativeCone5PFJets
  replace patAODJetTracksAssociator.tracks = ic5PFJetTracksAssociatorAtVertex
  replace layer0JetTracksAssociator.collection  = allLayer0PFJets
  replace layer0JetTracksAssociator.association = patAODJetTracksAssociator
  replace layer0JetTracksAssociator.backrefs    = allLayer0PFJets
  ## Jet charge
  replace layer0JetCharge.src           = allLayer0PFJets
  ## Layer 1
  replace allLayer1Jets.jetSource = allLayer0PFJets
  replace allLayer1Jets.embedCaloTowers     = false // meaningless
  replace allLayer1Jets.addBTagInfo         = false // not in AOD
  replace allLayer1Jets.addResolutions      = false // not available
  replace allLayer1Jets.addJetCorrFactors   = false // not available

  path p = {
    # vvvv------ all the following is inside patLayer0
    patBeforeLevel0Reco,
    ic5PFJetTracksAssociatorAtVertex, # <<< ADDED  
    patLayer0Cleaners,
    allLayer0PFJets,                  # <<< ADDED
    patHighLevelReco, 
    patMCTruth,
    patTrigMatch,
    # ^^^^------
    content,                              # uncomment to get a dump of the event content
    patLayer1
  }


  ### Output ###

  # define the event content
  block patEventContent = {
    untracked vstring outputCommands = {
      "drop *"
    }
  }
  include "PhysicsTools/PatAlgos/data/patLayer1_EventContent.cff"
  replace patEventContent.outputCommands += patLayer1EventContent.outputCommands

  # only accept events passing the complete path
  block patEventSelection = {
    untracked PSet SelectEvents = {
      vstring SelectEvents = { "p" }
    }
  }

  # the actual output module
  module out = PoolOutputModule {
    untracked string fileName = "PATLayer1_Output.fromAOD_full.root"
    using patEventSelection
    using patEventContent
    untracked bool verbose = false
  }

  endpath outpath = { out }


}
